<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>CallingApp</title>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="sheet">
Â  Â <style>
* { box-sizing: border-box; }
Â  Â  Â  Â  :root {
Â  Â  --primary-color: #005c97;Â  Â  Â  /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
Â  Â  --accent-color: #34B7F1;Â  Â  Â  Â /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ Ù„Ù„ØªÙØ§Ø¹Ù„ */
Â  Â  --bg-color: #e5ddd5;Â  Â  Â  Â  Â  Â /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
Â  Â  --app-bg: #f0f2f5;Â  Â  Â  Â  Â  Â  Â /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
Â  Â  --msg-sent: #d9fdd3;Â  Â  Â  Â  Â  Â /* Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© */
Â  Â  --msg-received: #ffffff;Â  Â  Â  Â /* Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø© */
Â  Â  --danger-color: #ef5350;Â  Â  Â  Â /* Ø£Ø­Ù…Ø± Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª */
Â  Â  --success-color: #4caf50;Â  Â  Â  /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù‚Ø¨ÙˆÙ„ */
Â  Â  --text-primary: #111b21;
Â  Â  --text-secondary: #667781;
}
Â  Â  Â  /* ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ù„ÙƒÙ„Ù…Ø© typing... */
#typing-status {
Â  Â  font-style: italic;
Â  Â  animation: blink 1.5s infinite;
}
@keyframes blink {
Â  Â  0% { opacity: 0.4; }
Â  Â  50% { opacity: 1; }
Â  Â  100% { opacity: 0.4; }
}

/* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙØ§Ø¦ØªØ© */
.missed-call {
Â  Â  border-left: 4px solid var(--danger-color);
}
body, html {
Â  Â  margin: 0; padding: 0; height: 100%;
Â  Â  font-family: 'Roboto', sans-serif;
Â  Â  background-color: #d1d7db;
Â  Â  display: flex; justify-content: center; align-items: center;
}

#app-container {
Â  Â  width: 100%; max-width: 450px; height: 100%; max-height: 900px;
Â  Â  background-color: #fff; position: relative; overflow: hidden;
Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

@media (min-width: 480px) { #app-container { height: 95vh; border-radius: 12px; } }

/* Utility Classes */
.view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: white; z-index: 10; }
.hidden { display: none !important; }
.icon-btn { background: none; border: none; cursor: pointer; padding: 8px; color: white; }
.icon-btn svg { width: 24px; height: 24px; }
.error-message { color: var(--danger-color); font-size: 12px; margin-top: 5px; min-height: 15px; }

/* Auth View */
#auth-view { justify-content: center; align-items: center; padding: 30px; background: var(--app-bg); text-align: center; }
#auth-view h1 { color: var(--primary-color); margin-bottom: 40px; }
#auth-view input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
#auth-view button { width: 100%; padding: 12px; background: var(--success-color); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; }
#auth-view a { display: block; margin-top: 15px; color: var(--primary-color); text-decoration: none; font-size: 14px; }

/* Main Header */
.main-header { background-color: var(--primary-color); color: white; padding-top: 10px; }
.header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
.header-nav { display: flex; justify-content: space-around; padding-bottom: 0; }
.nav-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; opacity: 0.7; border-bottom: 3px solid transparent; font-weight: 500; text-transform: uppercase; font-size: 14px; color: white; }
.nav-tab.active { opacity: 1; border-bottom-color: white; }
.badge { background: var(--danger-color); padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; vertical-align: top; }

/* Lists */
.list-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
.list-item:hover { background: #f5f5f5; }
.avatar { width: 45px; height: 45px; background: #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 15px; font-size: 20px; color: white; font-weight: bold; }
.item-info { flex: 1; }
.item-title { font-weight: bold; color: var(--text-primary); }
.item-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }

/* Chat View */
#chat-view { background: var(--bg-color); z-index: 20; }
.chat-header { background: var(--primary-color); color: white; padding: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.contact-info { flex: 1; display: flex; flex-direction: column; }
#contact-name { font-weight: bold; font-size: 16px; }
#contact-username { font-size: 12px; opacity: 0.8; }
#chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"); }

.message { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 14px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); margin-bottom: 2px; }
.msg-sent { background: var(--msg-sent); align-self: flex-end; border-top-right-radius: 0; }
.msg-received { background: var(--msg-received); align-self: flex-start; border-top-left-radius: 0; }

#chat-input-container { padding: 8px; background: #f0f2f5; display: flex; align-items: center; gap: 8px; }
#chat-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; }
#chat-send-btn { background: var(--success-color); border-radius: 50%; width: 40px; height: 40px; padding: 8px; display: flex; justify-content: center; align-items: center; }

/* Call View */
.call-view { background: #000; z-index: 30; align-items: center; justify-content: center; }
video, audio { width: 100%; height: 100%; object-fit: cover; }
#local-video { position: absolute; bottom: 120px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid white; z-index: 31; }
.call-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 30%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 40px; color: white; z-index: 32; }
.call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; color: white; }
.end-call, .reject-call { background: var(--danger-color); }
.accept-call { background: var(--success-color); }

/* Modals */
.modal { background: rgba(0,0,0,0.6); z-index: 50; justify-content: center; align-items: center; }
.modal-content { background: white; padding: 25px; border-radius: 10px; width: 85%; max-width: 350px; text-align: center; }
.modal-content input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
.modal-content button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: var(--primary-color); color: white; margin-top: 10px; }
/* CSS will go hereâ˜ï¸ in Part 2 */

Â  Â  </style>
</head>
<body>
Â  Â  <div id="app-container">
Â  Â  Â  Â  <!-- Auth View -->
Â  Â  Â  Â  <div id="auth-view" class="view">
Â  Â  Â  Â  Â  Â  <h1>CallingApp</h1>
Â  Â  Â  Â  Â  Â  <form id="login-form">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="login-email" placeholder="Email" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login-password" placeholder="Password" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">Login</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="login-error" class="error-message"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="switch-to-signup">Don't have an account? Sign up</a>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <form id="signup-form" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="signup-email" placeholder="Email" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="signup-password" placeholder="Password" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">Sign Up</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="signup-error" class="error-message"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="switch-to-login">Already have an account? Login</a>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Main App View -->
Â  Â  Â  Â  <div id="main-view" class="view" style="display: none;">
Â  Â  Â  Â  Â  Â  <header class="main-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>CallingApp</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-friend-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12 4V20M20 12H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="menu-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12 8C13.1 8 14 7.1 14 6C14 4.9 13.1 4 12 4C10.9 4 10 4.9 10 6C10 7.1 10.9 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM12 16C10.9 16 10 16.9 10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18C14 16.9 13.1 16 12 16Z" fill="currentColor"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <nav class="header-nav">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="nav-home" class="nav-tab active">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Chats <span class="badge" style="display: none;"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="nav-notifications" class="nav-tab">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Updates <span class="badge" style="display: none;"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="nav-calls" class="nav-tab">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Calls <span class="badge" style="display: none;"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <main id="main-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="home-content" class="content-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Chats list will be populated here -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="notifications-content" class="content-panel" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Updates list will be populated here -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="calls-content" class="content-panel" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Calls list will be populated here -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Chat View -->
Â  Â  Â  Â  <div id="chat-view" class="view" style="display: none;">
Â  Â  Â  Â  Â  Â  <header class="chat-header">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="chat-back-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="contact-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="contact-username"></span> - <span id="contact-name"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="typing-status" style="font-size: 11px; color: #dcf8c6; height: 14px;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="voice-call-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M3 5C3 4.44772 3.44772 4 4 4H8.58579C8.851 4 9.10536 4.10536 9.29289 4.29289L11.2929 6.29289C11.4804 6.48043 11.7348 6.58579 12 6.58579C12.2652 6.58579 12.5196 6.48043 12.7071 6.29289L14.7071 4.29289C14.8946 4.10536 15.149 4 15.4142 4H20C20.5523 4 21 4.44772 21 5V19C21 19.5523 20.5523 20 20 20H4C3.44772 20 3 19.5523 3 19V5Z" stroke="currentColor" stroke-width="2"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="video-call-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M15 10L11 7.11325V12.8868L15 10ZM21 10C21 13.866 17.4183 17 13 17V19C18.5228 19 23 14.9706 23 10H21ZM13 3C17.4183 3 21 6.13401 21 10H23C23 5.02944 18.5228 1 13 1V3ZM13 17C8.58172 17 5 13.866 5 10H3C3 14.9706 7.47715 19 13 19V17ZM5 10C5 6.13401 8.58172 3 13 3V1C7.47715 1 3 5.02944 3 10H5Z" fill="currentColor"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="chat-more-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12 8C13.1 8 14 7.1 14 6C14 4.9 13.1 4 12 4C10.9 4 10 4.9 10 6C10 7.1 10.9 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM12 16C10.9 16 10 16.9 10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18C14 16.9 13.1 16 12 16Z" fill="currentColor"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <div id="chat-messages"></div>
Â  Â  Â  Â  Â  Â  <div id="chat-input-container">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chat-input" placeholder="Type a message...">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="chat-send-btn" class="icon-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Call Views -->
Â  Â  Â  Â  <div id="video-call-view" class="call-view" style="display: none;">
Â  Â  Â  Â  Â  Â  <video id="remote-video" autoplay></video>
Â  Â  Â  Â  Â  Â  <video id="local-video" autoplay muted></video>
Â  Â  Â  Â  Â  Â  <div class="call-overlay">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="caller-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="caller-name-video"></span> (<span id="caller-username-video"></span>)
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="call-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="end-call-btn-video" class="call-btn end-call">End Call</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="voice-call-view" class="call-view" style="display: none;">
Â  Â  Â  Â  Â  Â  <audio id="remote-audio" autoplay></audio>
Â  Â  Â  Â  Â  Â  <div class="call-overlay">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="caller-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="caller-name-voice"></span> (<span id="caller-username-voice"></span>)
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="call-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="end-call-btn-voice" class="call-btn end-call">End Call</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
// Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
elt('end-call-btn-video').onclick = endCallHandler;
elt('end-call-btn-voice').onclick = endCallHandler;
elt('reject-call-btn').onclick = () => {
Â  Â  elt('ringtone').pause();
Â  Â  closeModal('incoming-call-modal');
Â  Â  db.ref(`calls/${currentUser.uid}`).remove();
};
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Modals -->
Â  Â  Â  Â  <div id="profile-setup-modal" class="modal" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Set Up Your Profile</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="profile-name" placeholder="Your Name" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="profile-username" placeholder="Username (unique)" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="save-profile-btn">Save</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="profile-error" class="error-message"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="add-friend-modal" class="modal" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Add Friend</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="friend-username" placeholder="Enter friend's username" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="send-request-btn">Send Request</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="add-friend-error" class="error-message"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="profile-view-modal" class="modal" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Profile & Settings</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="user-info"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="edit-profile-btn">Edit Profile</button>
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Blocked Users</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <ul id="blocked-list"></ul>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="logout-btn">Logout</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="incoming-call-modal" class="modal" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Incoming Call</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="caller-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="incoming-caller-name"></span> (<span id="incoming-caller-username"></span>)
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="call-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="accept-call-btn" class="call-btn accept-call">Accept</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="reject-call-btn" class="call-btn reject-call">Reject</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <audio id="ringtone" loop>
Â  Â  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66hVFApGn+DyvmUdBzaO1fLMfCsFJXHH8N2QQAoUXrTp66h">
</audio>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
<script>
Â  Â  // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ) ---
Â  Â  const firebaseConfig = {
        apiKey: "AIzaSyDahFRB-bXcVahNiqf8HF_39N5ggBtbp0Y",
        authDomain: "callingapk.firebaseapp.com",
        databaseURL: "https://callingapk-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "callingapk",
        storageBucket: "callingapk.firebasestorage.app",
        messagingSenderId: "137198030264",
        appId: "1:137198030264:web:7dfa63545871e7aabd134d",
        measurementId: "G-BKJD2YKYBR"
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ´ØºÙŠÙ„ Firebase Ø¨Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.database();
    const analytics = firebase.analytics(); // Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù„Ø£Ù† MeasurementId Ù…ÙˆØ¬ÙˆØ¯

    // --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let currentUser = null, currentProfile = null;
    let currentChatPartner = null;
    let peerConnection = null, localStream = null;
    
    const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }, // Ø®Ø§Ø¯Ù… Ø¬ÙˆØ¬Ù„ STUN
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ø¯Ù… TURN ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ 4G
        /* { 
            urls: 'turn:your-turn-server.com', 
            username: 'user', 
            credential: 'password' 
        } */
    ]
};

 // --- 3. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (UI Helpers) ---
Â  Â  const elt = (id) => document.getElementById(id);
Â  Â  const showView = (id) => {
Â  Â  Â  Â  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
Â  Â  Â  Â  elt(id).style.display = 'flex';
Â  Â  };
Â  Â  const showModal = (id) => elt(id).style.display = 'flex';
Â  Â  const closeModal = (id) => elt(id).style.display = 'none';

Â  Â  // --- 4. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth & Profile) ---
Â  Â  auth.onAuthStateChanged(user => {
    // 1. Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŸ
    if (user) {
        // 2. Ù‡Ù„ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªÙˆØ«ÙŠÙ‚ Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŸ
        if (user.emailVerified) {
            currentUser = user;
            db.ref(`users/${user.uid}`).once('value', snap => {
                if (snap.exists()) {
                    currentProfile = snap.val();
                    initApp();
                } else {
                    showView('main-view');
                    showModal('profile-setup-modal');
                }
            });
        } else {
            // 3. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ«Ù‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ù‡ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ£ÙƒØ¯
            console.log("Email not verified yet.");
            showView('auth-view'); 
            // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§
        }
    } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
        showView('auth-view');
    }
});

Â  Â  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
Â  Â  elt('login-form').onsubmit = (e) => {
    e.preventDefault();
    const email = elt('login-email').value;
    const password = elt('login-password').value;

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            
            if (user.emailVerified) {
                // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…ÙˆØ«Ù‚ -> Ø§Ø¯Ø®Ù„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
                showView('main-view');
            } else {
                // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ«Ù‚ -> Ø£Ø®Ø±Ø¬Ù‡ ÙˆØ£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø©
                alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹.");
                auth.signOut();
            }
        })
        .catch(err => {
            alert(err.message);
        });
};
Â  Â  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
Â  // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Signup)
elt('signup-form').onsubmit = (e) => {
    e.preventDefault();
    elt('signup-error').innerText = "";
    const email = elt('signup-email').value;
    const password = elt('signup-password').value;

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
            const actionCodeSettings = {
                // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Netlify Ø£Ùˆ Firebase
                url: 'https://gameesite.github.io/Callingapk/', 
                handleCodeInApp: true,
            };

            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            userCredential.user.sendEmailVerification(actionCodeSettings)
                .then(() => {
                    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªÙØ¹ÙŠÙ„Ù‡.");
                    
                    // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù…Ù†Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„
                    auth.signOut().then(() => {
                        elt('signup-form').reset();
                        showView('auth-view'); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    });
                });
        })
        .catch(err => {
            elt('signup-error').innerText = err.message;
        });
};

Â  Â  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
Â  Â  elt('switch-to-signup').onclick = () => { elt('login-form').style.display='none'; elt('signup-form').style.display='block'; };
Â  Â  elt('switch-to-login').onclick = () => { elt('signup-form').style.display='none'; elt('login-form').style.display='block'; };

Â  Â  // Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù…Ø¹ Ù†Ø¸Ø§Ù… Username)
Â  Â  elt('save-profile-btn').onclick = () => {
Â  Â  Â  Â  const username = elt('profile-username').value.trim().toLowerCase().replace(/\s/g, '');
Â  Â  Â  Â  const name = elt('profile-name').value;
Â  Â  Â  Â  if (username.length < 3) return alert("Username too short!");

Â  Â  Â  Â  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
Â  Â  Â  Â  db.ref(`usernames/${username}`).once('value', snap => {
Â  Â  Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  elt('profile-error').innerText = "Username already taken!";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const profile = { name, username, uid: currentUser.uid, email: currentUser.email };
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  Â  Â  updates[`users/${currentUser.uid}`] = profile;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`usernames/${username}`] = currentUser.uid; // Ø±Ø¨Ø· Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù€ UID

Â  Â  Â  Â  Â  Â  Â  Â  db.ref().update(updates).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentProfile = profile;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal('profile-setup-modal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initApp();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  function loadCallLogs() {
Â  Â  db.ref(`callLogs/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).on('value', snap => {
Â  Â  Â  Â  const callsList = elt('calls-content');
Â  Â  Â  Â  callsList.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(child => { logs.unshift({id: child.key, ...child.val()}); });

Â  Â  Â  Â  logs.forEach(log => {
Â  Â  Â  Â  Â  Â  const date = new Date(log.timestamp).toLocaleTimeString();
Â  Â  Â  Â  Â  Â  const isMissed = log.status === 'missed';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'list-item';
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="avatar" style="background: ${isMissed ? '#ef5350' : '#4caf50'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${log.type === 'video' ? 'ğŸ“¹' : 'ğŸ“'}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-title" style="color: ${isMissed ? '#ef5350' : 'black'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${log.callerName} ${isMissed ? '(Missed)' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-subtitle">${date}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  callsList.appendChild(div);
Â  Â  Â  Â  });
Â  Â  });
}
function monitorPresence() {
    const statusRef = db.ref(`users/${currentUser.uid}/status`);
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', snap => {
        if (snap.val() === true) {
            statusRef.set('online');
            statusRef.onDisconnect().set('offline');
        }
    });
}
Â  Â  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
Â  Â  function initApp() {
Â  Â  showView('main-view');
Â  Â  loadContacts();
Â  Â  listenForIncomingCalls();
Â  Â  listenForRequests();
Â  Â  monitorPresence(); // Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ØªØµÙ„)
Â  Â  loadCallLogs();Â  Â  // Ù…ÙŠØ²Ø© Ø³Ø¬Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
}

Â  Â  // --- 5. Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª (Ù†Ø¸Ø§Ù… Username) ---
Â  Â  elt('add-friend-btn').onclick = () => showModal('add-friend-modal');
Â  Â Â 
Â  Â  elt('send-request-btn').onclick = () => {
Â  Â  Â  Â  const targetUser = elt('friend-username').value.trim().toLowerCase();
Â  Â  Â  Â  if (targetUser === currentProfile.username) return alert("You cannot add yourself!");

Â  Â  Â  Â  db.ref(`usernames/${targetUser}`).once('value', snap => {
Â  Â  Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  elt('add-friend-error').innerText = "User not found.";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const targetUid = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`users/${targetUid}/requests/${currentUser.uid}`).set({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  from: currentUser.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: currentProfile.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  username: currentProfile.username
Â  Â  Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Friend request sent!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal('add-friend-modal');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
Â  Â  function listenForRequests() {
Â  Â  Â  Â  db.ref(`users/${currentUser.uid}/requests`).on('child_added', snap => {
Â  Â  Â  Â  Â  Â  const req = snap.val();
Â  Â  Â  Â  Â  Â  const confirm = window.confirm(`Accept request from @${req.username} (${req.name})?`);
Â  Â  Â  Â  Â  Â  if (confirm) {
Â  Â  Â  Â  Â  Â  Â  Â  // Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø±ÙÙŠÙ†)
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`users/${currentUser.uid}/contacts/${snap.key}`).set({ name: req.name, username: req.username, uid: snap.key });
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`users/${snap.key}/contacts/${currentUser.uid}`).set({ name: currentProfile.name, username: currentProfile.username, uid: currentUser.uid });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  snap.ref.remove(); // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- 6. Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---
Â  Â  function loadContacts() {
    const contactsPath = db.ref(`users/${currentUser.uid}/contacts`);
    
    // 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
    contactsPath.off(); 

    contactsPath.on('value', snap => {
        const list = elt('home-content');
        list.innerHTML = '';
        
        snap.forEach(child => {
            const c = child.val();
            const statusPath = db.ref(`users/${c.uid}/status`);
            
            // 2. Ø¥ÙŠÙ‚Ø§Ù Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµØ¯ÙŠÙ‚ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¦Ù‡
            statusPath.off(); 

            statusPath.on('value', statusSnap => {
                const status = statusSnap.val() || 'offline';
                const statusColor = status === 'online' ? '#4caf50' : '#9e9e9e';
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡
                let contactDiv = document.getElementById(`contact-${c.uid}`);
                if (!contactDiv) {
                    contactDiv = document.createElement('div');
                    contactDiv.id = `contact-${c.uid}`;
                    contactDiv.className = 'list-item';
                    list.appendChild(contactDiv);
                }

                contactDiv.innerHTML = `
                    <div class="avatar" style="position: relative;">
                        ${c.name[0].toUpperCase()}
                        <span style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ${statusColor}; border: 2px solid white; border-radius: 50%;"></span>
                    </div>
                    <div class="item-info">
                        <div class="item-title">${c.name}</div>
                        <div class="item-subtitle">${status === 'online' ? 'Active now' : 'Offline'}</div>
                    </div>
                `;
                contactDiv.onclick = () => openChat(c);
            });
        });
    });
}

Â  Â  function openChat(contact) {
Â  Â  Â  Â  currentChatPartner = contact;
Â  Â  Â  Â  elt('contact-name').innerText = contact.name;
Â  Â  Â  Â  elt('contact-username').innerText = '@' + contact.username;
Â  Â  Â  Â  showView('chat-view');

Â  Â  Â  Â  const chatId = [currentUser.uid, contact.uid].sort().join('_');
Â  Â  Â  Â  const msgsRef = db.ref(`messages/${chatId}`);
Â  Â  Â  Â  elt('chat-messages').innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  msgsRef.off();
Â  Â  Â  Â  msgsRef.limitToLast(50).on('child_added', snap => {
Â  Â  Â  Â  Â  Â  const msg = snap.val();
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = `message ${msg.sender === currentUser.uid ? 'msg-sent' : 'msg-received'}`;
Â  Â  Â  Â  Â  Â  div.innerText = msg.text;
Â  Â  Â  Â  Â  Â  elt('chat-messages').appendChild(div);
Â  Â  Â  Â  Â  Â  elt('chat-messages').scrollTop = elt('chat-messages').scrollHeight;
Â  Â  Â  Â  });
Â  Â  }
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø²Ù…Ù†ÙŠ
let typingTimeout;

elt('chat-input').addEventListener('input', () => {
Â  Â  if (!currentChatPartner) return;

Â  Â  const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
Â  Â  const typingRef = db.ref(`typing/${chatId}/${currentUser.uid}`);

Â  Â  // Ø£Ø®Ø¨Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£Ù†Ùƒ ØªÙƒØªØ¨
Â  Â  typingRef.set(true);

Â  Â  // Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù…Ø¯Ø© 2 Ø«Ø§Ù†ÙŠØ©ØŒ Ù†Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„Ø©
Â  Â  clearTimeout(typingTimeout);
Â  Â  typingTimeout = setTimeout(() => {
Â  Â  Â  Â  typingRef.remove();
Â  Â  }, 2000);
});

    function listenForTyping(contactUid) {
    const chatId = [currentUser.uid, contactUid].sort().join('_');
    const partnerTypingRef = db.ref(`typing/${chatId}/${contact.Uid}`);
    
    partnerTypingRef.off('value', snap => {
        const statusElt = elt('typing-status');
        if (snap.exists() && snap.val() === true) {
            statusElt.innerText = 'typing...';
        } else {
            statusElt.innerText = '';
        }
    });
}
// Ù„Ø§ ØªÙ†Ø³Ù Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ openChat
// listenForTyping(contact.uid);
    elt('chat-back-btn').onclick = () => showView('main-view');

    elt('chat-send-btn').onclick = () => {
        const text = elt('chat-input').value;
        if (!text.trim()) return;
        const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
        db.ref(`messages/${chatId}`).push({
            sender: currentUser.uid, text, timestamp: Date.now()
        });
        elt('chat-input').value = '';
    };
    // --- 7. Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (WebRTC) ---
    elt('video-call-btn').onclick = () => startCall(true);
    elt('voice-call-btn').onclick = () => startCall(false);

    async function startCall(video) {
    // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠ Analytics
    analytics.logEvent('call_started', {
        type: video ? 'video' : 'voice',
        time: new Date().toISOString()
    });

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        elt(video ? 'caller-name-video' : 'caller-name-voice').innerText = currentChatPartner.name;
        elt(video ? 'caller-username-video' : 'caller-username-voice').innerText = '@' + currentChatPartner.username;

        localStream = await navigator.mediaDevices.getUserMedia({ video: video, audio: true });
        if (video) elt('local-video').srcObject = localStream;

        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = e => {
            (video ? elt('remote-video') : elt('remote-audio')).srcObject = e.streams[0];
        };

        peerConnection.onicecandidate = e => {
            if (e.candidate) db.ref(`calls/${currentChatPartner.uid}/candidates`).push(e.candidate.toJSON());
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        db.ref(`calls/${currentChatPartner.uid}`).set({
            caller: currentUser.uid,
            callerName: currentProfile.name,
            callerUsername: currentProfile.username,
            type: video ? 'video' : 'voice',
            offer: { type: offer.type, sdp: offer.sdp }
        });

        db.ref(`calls/${currentChatPartner.uid}/answer`).on('value', async snap => {
            if (snap.exists() && !peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
            }
        });

        db.ref(`calls/${currentChatPartner.uid}/remoteCandidates`).on('child_added', snap => {
            peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
        });
    }

    function logCall(targetUid, type, status) {
    const callLogRef = db.ref(`callLogs/${targetUid}`).push();
    const callLogData = {
        callerId: currentUser.uid,
        callerName: currentProfile.name,
        type: type, // 'video' or 'voice'
        status: status, // 'missed', 'accepted'
        timestamp: Date.now()
    };
    callLogRef.set(callLogData);
    return callLogRef.key; // Ø³Ù†Ø­ØªØ§Ø¬Ù‡ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ø±ØºØ¨Ù†Ø§
}

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
function listenForIncomingCalls() {
    const callRef = db.ref(`calls/${currentUser.uid}`);
    callRef.off(); // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚

    callRef.on('value', snap => {
        const data = snap.val();
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ø±Ø¶ ÙˆØ¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø©
        if (data && data.offer && !data.answer) {
            if (elt('incoming-call-modal').style.display === 'flex') return;
            elt('incoming-caller-name').innerText = data.callerName;
            elt('incoming-caller-username').innerText = '@' + data.callerUsername;
            showModal('incoming-call-modal');
            elt('ringtone').play().catch(e => console.log(e));
            window.incomingCallData = data;
        } 
        // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…ØªØµÙ„ Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        else if (!data) {
            closeModal('incoming-call-modal');
            elt('ringtone').pause();
            elt('ringtone').currentTime = 0;
        }
    });
}

elt('accept-call-btn').onclick = async () => {
    closeModal('incoming-call-modal');
    elt('ringtone').pause();
    const data = window.incomingCallData;
    if (!data) return;

    isVideoCall = (data.type === 'video');
    showView(isVideoCall ? 'video-call-view' : 'voice-call-view');
    elt(isVideoCall ? 'caller-name-video' : 'caller-name-voice').innerText = data.callerName;
    
    localStream = await navigator.mediaDevices.getUserMedia({ video: isVideoCall, audio: true });
    if (isVideoCall) elt('local-video').srcObject = localStream;

    peerConnection = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = e => {
        (isVideoCall ? elt('remote-video') : elt('remote-audio')).srcObject = e.streams[0];
    };

    peerConnection.onicecandidate = e => {
        if (e.candidate) db.ref(`calls/${data.caller}/remoteCandidates`).push(e.candidate.toJSON());
    };

    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    db.ref(`calls/${currentUser.uid}/answer`).set({ type: answer.type, sdp: answer.sdp });
    
    // ØªÙ†Ø¸ÙŠÙ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    const candidatesRef = db.ref(`calls/${currentUser.uid}/candidates`);
    candidatesRef.off(); 
    candidatesRef.on('child_added', snap => {
        if (peerConnection) peerConnection.addIceCandidate(new RTCIceCandidate(snap.val())).catch(e => {});
    });
};

// Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
async function endCallHandler() {
    elt('ringtone').pause();
    elt('ringtone').currentTime = 0;

    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    db.ref(`calls/${currentUser.uid}`).off();
    db.ref(`calls/${currentUser.uid}/candidates`).off();

    if (currentChatPartner) {
        db.ref(`calls/${currentChatPartner.uid}/remoteCandidates`).off();
        await db.ref(`calls/${currentChatPartner.uid}`).remove();
    }
    await db.ref(`calls/${currentUser.uid}`).remove();

    // ØªØµÙÙŠØ± Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©
    if (elt('remote-video')) elt('remote-video').srcObject = null;
    if (elt('local-video')) elt('local-video').srcObject = null;
    showView('main-view');
}

    // 5. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    showView('main-view');
    console.log("Call ended and resources cleaned up.");
}
elt('end-call-btn-video').onclick = endCallHandler;
elt('end-call-btn-voice').onclick = endCallHandler;
elt('reject-call-btn').onclick = () => {
    elt('ringtone').pause();
    closeModal('incoming-call-modal');
    db.ref(`calls/${currentUser.uid}`).remove();
    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙƒÙ…ÙƒØ§Ù„Ù…Ø© ÙØ§Ø¦ØªØ©
    logCall(currentUser.uid, 'voice', 'missed'); 
};
    // --- 8. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
    elt('menu-btn').onclick = () => {
        elt('user-info').innerHTML = `<h3>${currentProfile.name}</h3><p>@${currentProfile.username}</p>`;
        showModal('profile-view-modal');
    };
// --- Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Chats, Updates, Calls) ---
    const tabs = [
        { btn: 'nav-home', content: 'home-content' },
        { btn: 'nav-notifications', content: 'notifications-content' },
        { btn: 'nav-calls', content: 'calls-content' }
    ];

    tabs.forEach(tab => {
        elt(tab.btn).onclick = () => {
            // 1. Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
            document.querySelectorAll('.content-panel').forEach(p => p.style.display = 'none');
            // 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
            elt(tab.content).style.display = 'block';
            elt(tab.btn).classList.add('active');

            // 4. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù‡Ùˆ "Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª"ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
            if (tab.btn === 'nav-calls') {
                loadCallLogs();
            }
        };
    });

    document.getElementById('logout-btn').onclick = () => {
    analytics.logEvent('user_logout');
    auth.signOut().then(() => window.location.reload());
};

</script>
</body>
</html>

